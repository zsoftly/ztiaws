name: CI/CD Pipeline

# Efficient path-based triggering:
# - Go code changes → test + security jobs
# - Script changes → lint-scripts job
# - Tags → build + release jobs only

on:
  push:
    branches: [main, 'feature/*', 'feat/*', 'issue/*', 'release/*']
    tags:
      - '[0-9]*'
  pull_request:
    branches: [main, 'release/*']
  workflow_dispatch:

jobs:
  # Determine which jobs to run based on changed files
  changes:
    name: 1. Detect Changes
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')
    outputs:
      go: ${{ steps.filter.outputs.go }}
      scripts: ${{ steps.filter.outputs.scripts }}
      workflow: ${{ steps.filter.outputs.workflow }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go:
              - 'ztictl/**'
              - 'go.mod'
              - 'go.sum'
              - 'Makefile'
            scripts:
              - 'authaws'
              - 'ssm'
              - 'src/**'
              - 'scripts/**'
              - 'tools/**'
              - '01_install.sh'
              - '02_uninstall.sh'
            workflow:
              - '.github/workflows/**'

  lint-scripts:
    name: 2a. Lint Scripts
    runs-on: ${{ matrix.os }}
    needs: changes
    if: needs.changes.outputs.scripts == 'true' || needs.changes.outputs.workflow == 'true'

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y shellcheck
          else
            brew install shellcheck
          fi
        shell: bash

      - name: Lint shell scripts (shellcheck)
        run: |
          echo "Checking shell scripts with shellcheck..."
          shellcheck -x authaws ssm src/*.sh tools/*.sh scripts/*.sh 01_install.sh 02_uninstall.sh
          echo "Shell scripts passed shellcheck"

      - name: Validate shell script syntax
        run: |
          echo "Validating shell script syntax..."
          for script in authaws ssm src/*.sh tools/*.sh scripts/*.sh 01_install.sh 02_uninstall.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" || exit 1
            fi
          done
          echo "Shell script syntax is valid"

      - name: Notify on shell test failure
        if: failure() && matrix.os == 'ubuntu-latest' && github.event_name == 'pull_request'
        env:
          GOOGLE_CHAT_WEBHOOK: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          if [[ -n "$GOOGLE_CHAT_WEBHOOK" ]]; then
            ./scripts/send-pr-notification.sh \
              --pr-title "$PR_TITLE" \
              --pr-number "$PR_NUMBER" \
              --pr-url "$PR_URL" \
              --author "$PR_AUTHOR" \
              --repository "$REPO" \
              --status "failure" \
              --message "Shell script tests failed - PR needs attention" || true
          fi
        continue-on-error: true

  test:
    name: 2b. Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.workflow == 'true'

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Get dependencies
        working-directory: ./ztictl
        run: go mod download

      - name: Run tests
        working-directory: ./ztictl
        env:
          AWS_EC2_METADATA_DISABLED: 'true'
          AWS_ACCESS_KEY_ID: 'AKIAIOSFODNN7EXAMPLE'
          AWS_SECRET_ACCESS_KEY: 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
          AWS_SESSION_TOKEN: 'test-session-token'
          AWS_REGION: 'ca-central-1'
        run: go test -v ./...

      - name: Run go vet
        working-directory: ./ztictl
        run: go vet ./...

      - name: Check formatting
        working-directory: ./ztictl
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            git config core.autocrlf false
            git checkout HEAD -- .
          fi

          UNFORMATTED=$(gofmt -s -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files are not formatted correctly:"
            echo "$UNFORMATTED"
            echo ""
            echo "Please run 'gofmt -s -w .' to fix formatting issues."
            exit 1
          fi
          echo "All Go files are properly formatted."

      - name: Test build
        working-directory: ./ztictl
        run: go build -o ztictl${{ matrix.os == 'windows-latest' && '.exe' || '' }} ./cmd/ztictl

      - name: Test CLI commands
        working-directory: ./ztictl
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            ZTICTL_EXE="./ztictl.exe"
          else
            ZTICTL_EXE="./ztictl"
          fi

          $ZTICTL_EXE --help
          $ZTICTL_EXE config --help
          $ZTICTL_EXE auth --help
          $ZTICTL_EXE ssm --help
          $ZTICTL_EXE --version
          $ZTICTL_EXE config validate || echo "Expected to fail without config"
          $ZTICTL_EXE config show || echo "Expected to work with defaults"
          $ZTICTL_EXE config check || echo "Expected to show missing dependencies"

      - name: Notify on Go test failure
        if: failure() && matrix.os == 'ubuntu-latest' && github.event_name == 'pull_request'
        env:
          GOOGLE_CHAT_WEBHOOK: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          if [[ -n "$GOOGLE_CHAT_WEBHOOK" ]]; then
            ./scripts/send-pr-notification.sh \
              --pr-title "$PR_TITLE" \
              --pr-number "$PR_NUMBER" \
              --pr-url "$PR_URL" \
              --author "$PR_AUTHOR" \
              --repository "$REPO" \
              --status "failure" \
              --message "Go tests failed - PR needs attention" || true
          fi
        continue-on-error: true

  security:
    name: 3. Security Analysis
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: |
      github.event_name == 'pull_request' &&
      github.base_ref == 'main' &&
      (needs.changes.outputs.go == 'true' || needs.changes.outputs.workflow == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Download dependencies
        working-directory: ./ztictl
        run: go mod download

      - name: Install security tools
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: './ztictl'
          format: 'table'
          exit-code: '0'
        continue-on-error: true

      - name: Run golangci-lint with security checks
        working-directory: ./ztictl
        run: $(go env GOPATH)/bin/golangci-lint run --enable gosec || true
        continue-on-error: true

      - name: Run Go vulnerability check
        working-directory: ./ztictl
        run: govulncheck ./... || true
        continue-on-error: true

      - name: Run go vet
        working-directory: ./ztictl
        run: go vet ./...

      - name: Notify on security success
        if: success() && github.event_name == 'pull_request'
        env:
          GOOGLE_CHAT_WEBHOOK: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          if [[ -n "$GOOGLE_CHAT_WEBHOOK" ]]; then
            ./scripts/send-pr-notification.sh \
              --pr-title "$PR_TITLE" \
              --pr-number "$PR_NUMBER" \
              --pr-url "$PR_URL" \
              --author "$PR_AUTHOR" \
              --repository "$REPO" \
              --status "success" \
              --message "All tests passed - PR is ready for review" || true
          fi
        continue-on-error: true

  build:
    name: 4. Build (${{ matrix.goos }}-${{ matrix.goarch }})
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Get dependencies
        working-directory: ./ztictl
        run: go mod download

      - name: Build binary
        working-directory: ./ztictl
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          GIT_COMMIT=${GITHUB_SHA::8}
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GIT_COMMIT}"
          fi

          echo "Building version: ${VERSION}"

          BINARY_NAME="ztictl-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi

          go build \
            -ldflags "-X main.Version=${VERSION} -s -w" \
            -o "${BINARY_NAME}" \
            ./cmd/ztictl

          if [ "${{ matrix.goos }}" = "linux" ] && [ "${{ matrix.goarch }}" = "amd64" ]; then
            ./"${BINARY_NAME}" --version
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ztictl-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ztictl/ztictl-${{ matrix.goos }}-${{ matrix.goarch }}*
          retention-days: 30

  release:
    name: 5. GitHub Release
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release binaries
        run: |
          mkdir -p release/

          for dir in artifacts/*/; do
            platform=$(basename "$dir")
            cd "$dir"
            cp ./* "../../release/"
            if [[ "$platform" == *"windows"* ]]; then
              zip -r "../../release/${platform}.zip" ./*
            else
              tar -czf "../../release/${platform}.tar.gz" ./*
            fi
            cd - > /dev/null
          done

          cp scripts/install.sh release/
          cp scripts/install.ps1 release/

          echo "Release binaries:"
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-notification:
    name: 6. Release Notification
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send release notification
        env:
          GOOGLE_CHAT_WEBHOOK: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
        run: |
          set -euo pipefail

          if [[ "$GITHUB_REF" =~ ^refs/tags/[0-9].+ ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            echo "Error: Invalid tag format in GITHUB_REF: $GITHUB_REF"
            exit 1
          fi

          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${VERSION}"

          ./scripts/send-release-notification.sh \
            --version "$VERSION" \
            --release-url "$RELEASE_URL" \
            --repository '${{ github.repository }}'
        continue-on-error: true
